import shutil
import hashlib
import requests
import tarfile

ARCHIVE_NAME = '8cb21532d36692d7e80f9dcf77db6bc9c1c51079.tar.gz'
FILENAMES = ['CDMA_interception.wav']
FILE_DIGESTS = ['2561cedf92da80d0f7b74b859be1c8794c9c5eca']

def sha1(fname):
    hash_sha1 = hashlib.sha1()
    with open(fname, "rb") as f:
        for chunk in iter(lambda: f.read(4096), b""):
            hash_sha1.update(chunk)
    return hash_sha1.hexdigest()

r = requests.get('https://static.ctf.insecurity-insa.fr/'+ARCHIVE_NAME, stream=True)

if r.status_code == 200:
    with open(ARCHIVE_NAME, 'wb') as f:
        r.raw.decode_content = True
        shutil.copyfileobj(r.raw, f)

tar = tarfile.open(ARCHIVE_NAME)
tar.extractall()
tar.close()

print('Exploit OK' if all(sha1(filename) == digest for filename, digest in zip(FILENAMES, FILE_DIGESTS)) else 'Exploit error')
