"""Hell of a jail automated exploit."""
import yaml
from pwn import *
import os

if os.getenv("DEV") == "1":
    host = "localhost"
else:
    host = "hell-of-a-jail.ctf.insecurity-insa.fr"
keyfile = "keys/id_rsa"

with open("payload.py", "r") as payload:
    PAYLOAD = payload.readlines()

s = ssh(user="user", host=host, port=2222, keyfile=keyfile, level="error")
sh = s.shell()


def check_flag():
    with open("../.mkctf.yml", 'r') as f:
        flag = yaml.safe_load(f.read())['flag']
    sh.sendline("env | grep \"0f4d0db3668dd58cabb9eb409657eaa8\"")
    sh.recvuntil("=")
    remote_flag = sh.recvline().strip("\r\n")
    if flag != remote_flag:
        log.critical("Wrong flag")
        sys.exit(1)
    log.success("Flag is OK")


sh.recvuntil(">>>")
log.info("Jail is ready")

log.info("Sending payload")
for line in PAYLOAD:
    sh.sendline(line)
    sh.recvuntil(">>>")

sh.recvuntil("/sandbox $")
log.success("Payload sucessfull")

log.info("Checking flag")
check_flag()
log.success("Challenge is up")
exit(0)

